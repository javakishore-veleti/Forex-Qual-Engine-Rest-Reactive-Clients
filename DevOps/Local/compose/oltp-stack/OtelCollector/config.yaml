receivers:
  otlp:
    protocols:
      http:
      grpc:

  prometheus:
    config:
      scrape_configs:
        - job_name: 'fxqual-engine'
          metrics_path: /actuator/prometheus
          static_configs:
            - targets: ['fx-qual-engine:8080']


exporters:
  # Send traces to Jaeger via OTLP
  otlp/jaeger:
    endpoint: "fx-qual-jaeger:4317"
    tls:
      insecure: true

  # Prometheus Metrics exporter (Grafana scrapes this)
  prometheus:
    endpoint: "0.0.0.0:9464"

  # Debug logging exporter
  logging:
    loglevel: info


processors:
  batch:

  memory_limiter:
    limit_mib: 512
    spike_limit_mib: 128
    check_interval: 5s

  # Tail sampling keeps error traces + some success traces
  tail_sampling:
    decision_wait: 5s
    num_traces: 5000
    expected_new_traces_per_sec: 200
    policies:
      - name: keep-errors
        type: status_code
        status_code:
          status_codes: [ ERROR ]

      - name: keep-some-success
        type: probabilistic
        probabilistic:
          sampling_percentage: 15


service:
  pipelines:

    traces:
      receivers: [otlp]
      processors: [memory_limiter, tail_sampling, batch]
      exporters: [otlp/jaeger, logging]

    metrics:
      receivers: [otlp, prometheus]
      processors: [batch]
      exporters: [prometheus]

    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [logging]
