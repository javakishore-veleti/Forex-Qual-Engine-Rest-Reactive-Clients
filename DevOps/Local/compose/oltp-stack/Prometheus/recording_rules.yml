groups:
  - name: fxqual_latency_rules
    interval: 30s
    rules:

      # p50, p95, p99 latency for FX Qual REST API
      - record: fxqual:http_server_latency_p50
        expr: histogram_quantile(
          0.50,
          sum(rate(http_server_requests_seconds_bucket{service="fx-qual-engine"}[5m])) by (le)
          )

      - record: fxqual:http_server_latency_p95
        expr: histogram_quantile(
          0.95,
          sum(rate(http_server_requests_seconds_bucket{service="fx-qual-engine"}[5m])) by (le)
          )

      - record: fxqual:http_server_latency_p99
        expr: histogram_quantile(
          0.99,
          sum(rate(http_server_requests_seconds_bucket{service="fx-qual-engine"}[5m])) by (le)
          )

      # p95 per client strategy (RestClient vs RestTemplate vs WebClient)
      - record: fxqual:http_client_latency_p95
        expr: histogram_quantile(
          0.95,
          sum(rate(http_client_requests_seconds_bucket{service="fx-qual-engine"}[5m])) by (client, le)
          )

  - name: fxqual_kpi_rules
    interval: 1m
    rules:

      # Quotes per minute
      - record: fxqual:quotes_requested_per_min
        expr: sum(rate(fxqual_quotes_requested_total[1m]))

      - record: fxqual:quotes_qualified_per_min
        expr: sum(rate(fxqual_quotes_qualified_total[1m]))

      # Notional volume aggregation
      - record: fxqual:volume_by_pair
        expr: sum(rate(fxqual_volume_notional[1m])) by (pair)

      # Promo usage
      - record: fxqual:promo_usage_by_code
        expr: sum(rate(fxqual_promo_usage_total[1m])) by (promo)

  - name: fxqual_sre_golden_signals
    interval: 30s
    rules:
      # Request rate
      - record: fxqual:request_rate
        expr: sum(rate(http_server_requests_seconds_count{service="fx-qual-engine"}[1m]))

      # Error percentage
      - record: fxqual:error_rate_percent
        expr: |
          sum(rate(http_server_requests_seconds_count{service="fx-qual-engine",status!~"2.."}[1m]))
          /
          sum(rate(http_server_requests_seconds_count{service="fx-qual-engine"}[1m]))
          * 100
